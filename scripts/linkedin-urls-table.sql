-- =====================================================
-- TABLA: linkedin_urls
-- Descripción: Tabla para almacenar URLs de búsqueda de LinkedIn
-- =====================================================

CREATE TABLE IF NOT EXISTS webapp.linkedin_urls (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  profile_title VARCHAR(255) NOT NULL,
  profile_keyword VARCHAR(255) NOT NULL,
  linkedin_url TEXT NOT NULL,
  description TEXT,
  priority INTEGER DEFAULT 1 CHECK (priority BETWEEN 1 AND 5),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Índices para optimizar búsquedas
CREATE INDEX IF NOT EXISTS idx_linkedin_urls_profile_title ON webapp.linkedin_urls(profile_title);
CREATE INDEX IF NOT EXISTS idx_linkedin_urls_profile_keyword ON webapp.linkedin_urls(profile_keyword);
CREATE INDEX IF NOT EXISTS idx_linkedin_urls_priority ON webapp.linkedin_urls(priority);
CREATE INDEX IF NOT EXISTS idx_linkedin_urls_is_active ON webapp.linkedin_urls(is_active);
CREATE INDEX IF NOT EXISTS idx_linkedin_urls_created_at ON webapp.linkedin_urls(created_at);

-- Trigger para actualizar updated_at
CREATE TRIGGER update_linkedin_urls_updated_at 
    BEFORE UPDATE ON webapp.linkedin_urls 
    FOR EACH ROW EXECUTE FUNCTION webapp.update_updated_at_column();

-- Insertar datos de ejemplo basados en la tabla de URLs de LinkedIn Europa
INSERT INTO webapp.linkedin_urls (profile_title, profile_keyword, linkedin_url, description, priority) VALUES
('CEO', 'CEO', 'https://www.linkedin.com/search/results/people/?keywords=CEO&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Chief Executive Officer - Europa completa', 1),
('Founder', 'Founder', 'https://www.linkedin.com/search/results/people/?keywords=Founder&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Fundador - Europa completa', 1),
('General Manager', 'General Manager', 'https://www.linkedin.com/search/results/people/?keywords=%22General%20Manager%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Gerente General - Europa completa', 1),
('Managing Director', 'Managing Director', 'https://www.linkedin.com/search/results/people/?keywords=%22Managing%20Director%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Director Gerente - Europa completa', 1),
('Sales Director', 'Sales Director', 'https://www.linkedin.com/search/results/people/?keywords=%22Sales%20Director%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Director de Ventas - Europa completa', 2),
('Business Development Director', 'Business Development Director', 'https://www.linkedin.com/search/results/people/?keywords=%22Business%20Development%20Director%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Director de Desarrollo de Negocio - Europa completa', 2),
('Operations Director', 'Operations Director', 'https://www.linkedin.com/search/results/people/?keywords=%22Operations%20Director%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Director de Operaciones - Europa completa', 2),
('Technical Director', 'Technical Director', 'https://www.linkedin.com/search/results/people/?keywords=%22Technical%20Director%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Director Técnico - Europa completa', 2),
('Facility Manager', 'Facility Manager', 'https://www.linkedin.com/search/results/people/?keywords=%22Facility%20Manager%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Gerente de Instalaciones - Europa completa', 3),
('Purchasing Manager', 'Purchasing Manager', 'https://www.linkedin.com/search/results/people/?keywords=%22Purchasing%20Manager%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%22110%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Gerente de Compras - Europa completa', 3),
('Innovation Director', 'Innovation Director', 'https://www.linkedin.com/search/results/people/?keywords=%22Innovation%20Director%22&origin=FACETED_SEARCH&geoUrn=%5B%22102890719%22%2C%22105015875%22%2C%22103350119%22%2C%22101282230%22%2C%22102257491%22%2C%22100364837%22%2C%22100565514%22%2C%22105646813%22%5D&industryUrn=%5B%22104%22%2C%22105%22%2C%22106%22%2C%22107%22%2C%22108%22%2C%22109%22%2C%2210%22%2C%22111%22%2C%22112%22%2C%22113%22%2C%22114%22%2C%22115%22%2C%22116%22%2C%22117%22%2C%22118%22%2C%22119%22%2C%22120%22%2C%22121%22%2C%22122%22%2C%22123%22%2C%22124%22%2C%22125%22%2C%22126%22%2C%22127%22%2C%22128%22%2C%22129%22%2C%22130%22%2C%22131%22%2C%22132%22%2C%22133%22%2C%22134%22%2C%22135%22%2C%22136%22%2C%22137%22%2C%22138%22%2C%22139%22%2C%22140%22%2C%22141%22%2C%22142%22%2C%22143%22%2C%22144%22%2C%22145%22%2C%22146%22%5D&companySize=%5B%22A%22%2C%22B%22%2C%22C%22%2C%22D%22%2C%22E%22%2C%22F%22%2C%22G%22%2C%22H%22%5D', 'Director de Innovación - Europa completa', 3);

-- Vista para obtener URLs activas ordenadas por prioridad
CREATE OR REPLACE VIEW webapp.active_linkedin_urls AS
SELECT 
    id,
    profile_title,
    profile_keyword,
    linkedin_url,
    description,
    priority,
    created_at,
    updated_at
FROM webapp.linkedin_urls
WHERE is_active = true
ORDER BY priority ASC, profile_title ASC;

-- Función para obtener URLs por prioridad
CREATE OR REPLACE FUNCTION webapp.get_linkedin_urls_by_priority(p_priority INTEGER DEFAULT NULL)
RETURNS TABLE (
    id UUID,
    profile_title VARCHAR(255),
    profile_keyword VARCHAR(255),
    linkedin_url TEXT,
    description TEXT,
    priority INTEGER,
    created_at TIMESTAMP
) AS $$
BEGIN
    IF p_priority IS NULL THEN
        RETURN QUERY
        SELECT 
            lu.id,
            lu.profile_title,
            lu.profile_keyword,
            lu.linkedin_url,
            lu.description,
            lu.priority,
            lu.created_at
        FROM webapp.linkedin_urls lu
        WHERE lu.is_active = true
        ORDER BY lu.priority ASC, lu.profile_title ASC;
    ELSE
        RETURN QUERY
        SELECT 
            lu.id,
            lu.profile_title,
            lu.profile_keyword,
            lu.linkedin_url,
            lu.description,
            lu.priority,
            lu.created_at
        FROM webapp.linkedin_urls lu
        WHERE lu.is_active = true AND lu.priority = p_priority
        ORDER BY lu.profile_title ASC;
    END IF;
END;
$$ LANGUAGE plpgsql; 